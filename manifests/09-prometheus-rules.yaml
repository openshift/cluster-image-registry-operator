apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    name: image-registry-operator-alerts
  name: image-registry-operator-alerts
  namespace: openshift-image-registry
spec:
  groups:
  - name: ImageRegistryOperator
    rules:
    - alert: ImageRegistryStorageReconfigured
      expr: increase(image_registry_operator_storage_reconfigured_total[30m]) > 0
      labels:
        severity: warning
      annotations:
        message: |
          Image Registry Storage configuration has changed in the last 30
          minutes. This change may have caused data loss.
    - alert: ImportImageUsingV1Protocol
      expr: |
        (
            sum(
                max_over_time(apiserver_v1_image_imports_total[15m]) or apiserver_v1_image_imports_total * 0
            ) by (repository)
            -
            sum(
                max_over_time(apiserver_v1_image_imports_total[15m] offset 15m) or apiserver_v1_image_imports_total * 0
            ) by (repository)
        ) > 0
      labels:
        severity: warning
      annotations:
        message: |
          Registry repository {{ $labels.repository }} was imported using deprecated registry
          protocol v1. Support for protocol v1 will be deprecated, it is recommended to use an
          image registry that supports the newer v2 protocol.
